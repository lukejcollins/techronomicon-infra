name: Transfer Secrets to Preprod Environment

on:
  workflow_dispatch:

jobs:
  transfer-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt-get install -y jq

      - name: Get the public key for the environment
        id: get-public-key
        env:
          GH_PAT: ${{ secrets.ACTIONS_PAT }}
          REPO: lukejcollins/techronomicon
          ENVIRONMENT: preprod
        run: |
          curl -H "Authorization: token $GH_PAT" \
            https://api.github.com/repos/$REPO/environments/$ENVIRONMENT/secrets/public-key \
            -o public-key.json

      - name: Set public key and key id
        id: set-public-key
        run: |
          PUBLIC_KEY=$(jq -r '.key' public-key.json)
          KEY_ID=$(jq -r '.key_id' public-key.json)
          echo "::set-output name=public_key::$PUBLIC_KEY"
          echo "::set-output name=key_id::$KEY_ID"

      - name: Encrypt and upload secrets
        env:
          GH_PAT: ${{ secrets.ACTIONS_PAT }}
          REPO: lukejcollins/techronomicon
          ENVIRONMENT: preprod
          PUBLIC_KEY: ${{ steps.set-public-key.outputs.public_key }}
          KEY_ID: ${{ steps.set-public-key.outputs.key_id }}
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          PREPROD_AWS_ACCESS_KEY_ID: ${{ secrets.PREPROD_AWS_ACCESS_KEY_ID }}
          PREPROD_AWS_REGION: ${{ secrets.PREPROD_AWS_REGION }}
          PREPROD_AWS_SECRET_ACCESS_KEY: ${{ secrets.PREPROD_AWS_SECRET_ACCESS_KEY }}
          PREPROD_ECS_CLUSTER_NAME: ${{ secrets.PREPROD_ECS_CLUSTER_NAME }}
          PREPROD_ECS_SERVICE_NAME: ${{ secrets.PREPROD_ECS_SERVICE_NAME }}
          PREPROD_TECHRONOMICON_STORAGE_BUCKET_NAME: ${{ secrets.PREPROD_TECHRONOMICON_STORAGE_BUCKET_NAME }}
        run: |
          # Save the public key to a file
          echo "$PUBLIC_KEY" | base64 -d > public.pem

          # Declare an associative array with secrets
          declare -A SECRETS=(
            ["DJANGO_SECRET_KEY"]=$DJANGO_SECRET_KEY
            ["AWS_ACCESS_KEY_ID"]=$PREPROD_AWS_ACCESS_KEY_ID
            ["AWS_REGION"]=$PREPROD_AWS_REGION
            ["AWS_SECRET_ACCESS_KEY"]=$PREPROD_AWS_SECRET_ACCESS_KEY
            ["ECS_CLUSTER_NAME"]=$PREPROD_ECS_CLUSTER_NAME
            ["ECS_SERVICE_NAME"]=$PREPROD_ECS_SERVICE_NAME
            ["TECHRONOMICON_STORAGE_BUCKET_NAME"]=$PREPROD_TECHRONOMICON_STORAGE_BUCKET_NAME
          )
          
          for secret_key in "${!SECRETS[@]}"; do
            secret_value=${SECRETS[$secret_key]}
            # Encrypt the secret value
            ENCRYPTED_VALUE=$(echo -n "$secret_value" | openssl rsautl -encrypt -pubin -inkey public.pem | base64 | tr -d '\n')

            # Upload the encrypted secret
            curl -X PUT -H "Authorization: token $GH_PAT" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/$REPO/environments/$ENVIRONMENT/secrets/$secret_key \
              -d "$(jq -n --arg encrypted_value "$ENCRYPTED_VALUE" --arg key_id "$KEY_ID" '{encrypted_value: $encrypted_value, key_id: $key_id}')"
          done
